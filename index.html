<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebPlayer - 媒体浏览器</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" />
    <script>
        (function() {
            var userAgent = navigator.userAgent || navigator.vendor || window.opera;
            // Checks for mobile devices
            if (/android/i.test(userAgent) || ((/iPad|iPhone|iPod/.test(userAgent)) && !window.MSStream)) {
                document.documentElement.classList.add('mobile');
            }
        })();
    </script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #1e1e1e; color: #e0e0e0; }
        .container { max-width: 1200px; margin: auto; background: #2d2d30; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        h1 { text-align: center; color: #4d9deb; }
        .path-navigation { margin-bottom: 20px; padding: 10px; background-color: #3a3a3d; border-radius: 5px; display: flex; align-items: center; }
        .path-navigation span { font-size: 1.1em; color: #a0a0a0; max-width: calc(100% - 200px); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        #backButton, #homeButton {
            margin-right: 10px;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            background: linear-gradient(to right, #3385cc, #225ba3);
            color: white;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s ease, transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        #backButton:hover, #homeButton:hover {
            background-color: #0066cc;
            transform: scale(1.03);
            box-shadow: 0 6px 12px rgba(51, 133, 204, 0.6);
        }
        
        #backButton:active, #homeButton:active {
            transform: scale(0.97);
            box-shadow: 0 3px 6px rgba(0,0,0,0.5);
        }
        
        /* 搜索区域样式 */
        .search-container {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #3a3a3d;
            border-radius: 5px;
        }

        #searchForm {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        #searchInput {
            flex: 1;
            padding: 10px;
            border: 1px solid #555;
            border-radius: 4px;
            font-size: 1em;
            background-color: #3a3a3d;
            color: #e0e0e0;
        }

        #searchButton {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            background: linear-gradient(to right, #3385cc, #225ba3);
            color: white;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s ease,transform 0.3s ease, box-shadow 0.3s ease;
        }
        #searchButton:hover {
            background-color: #0066cc;
            transform: scale(1.03);
            box-shadow: 0 6px 12px rgba(51, 133, 204, 0.6);
        }
        #searchButton:active {
            transform: scale(0.97);
            box-shadow: 0 3px 6px rgba(0,0,0,0.5);
        }

        #searchHelpButton {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            background:linear-gradient(to right, #cc3c22, #cc3457);
            color: white;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s ease, transform 0.3s ease;
        }
        #searchHelpButton:hover {
            transform: scale(1.05);
            background-color: #992d1a;
            box-shadow: 0 6px 12px rgba(204, 60, 34, 0.6);
        }
        #searchHelpButton:active {
            transform: scale(0.8);
            box-shadow: 0 3px 6px rgba(0,0,0,0.5);
        }

        #searchOptions {
            margin-top: 10px;
            display: none;
        }

        .search-option-label {
            margin-right: 15px;
            color: #e0e0e0;
        }

        #maxResults {
            width: 60px;
            background-color: #3a3a3d;
            color: #e0e0e0;
            border: 1px solid #555;
        }
        
        /* 排序控件样式 */
        .sorting-controls {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        label[for="sortBy"] {
            font-weight: bold;
        }

        #sortBy {
            padding: 5px;
            border-radius: 4px;
            border: 3px solid #555;
            background-color: #3a3a3d;
            color: #e0e0e0;
        }

        #sortOrder {
            padding: 5px;
            border-radius: 4px;
            border: 3px solid #555;
            background-color: #3a3a3d;
            color: #e0e0e0;
        }
        

        label[for="mixSort"] {
            margin-left: 0px;
        }
        
        /* 排序下拉菜单样式 */
        .sort-dropdown {
            position: relative;
            display: inline-block;
        }

        .sort-menu-button {
            background-color: #3a3a3d;
            color: #e0e0e0;
            padding: 5px 10px;
            border: 1px solid #555;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1.2em;
            line-height: 1;
            transition: all 0.3s ease;
        }

        .sort-menu-button:hover {
            transform: scale(1.1);
            background-color: #4a4a4d;
        }
        .sort-menu-button:active {
            transform: scale(0.9);
            background-color: #2a2a2d;
        }

        .sort-dropdown-content {
            position: absolute;
            top: 100%;
            right: 0;
            background-color: #3a3a3d;
            border: 1px solid #555;
            border-radius: 4px;
            padding: 10px;
            z-index: 1000;
            min-width: 200px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.3);
        }

        .sort-option {
            margin-bottom: 10px;
        }

        .sort-option:last-child {
            margin-bottom: 0;
        }

        .sort-option label {
            display: block;
            margin-bottom: 5px;
            color: #e0e0e0;
        }

        .sort-option select {
            width: 100%;
            padding: 5px;
            border-radius: 4px;
            border: 1px solid #555;
            background-color: #2d2d30;
            color: #e0e0e0;
        }

        /* 网格布局样式 */
        #fileGrid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            padding: 0;
            list-style: none;
        }
        
        .grid-item {
            background: #3a3d41;
            border-radius: 12px;
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            display: flex;
            flex-direction: column;
            height: 100%;
            margin: 12px 0;
        }
        
        .grid-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.5);
        }
        
        .thumbnail-container {
            position: relative;
            width: 100%;
            height: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #45494f;
            overflow: hidden;
        }
        
        .thumbnail {
            max-width: 100%;
            max-height: 100%;
            object-fit: cover;
        }
        
        .icon {
            font-size: 3em;
            color: #a0a0a0;
        }
        
        .file-info {
            padding: 12px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        
        .file-name {
            font-weight: bold;
            margin-bottom: 8px;
            word-break: break-word;
            flex-grow: 1;
        }
        
        .file-size {
            font-size: 0.85em;
            color: #a0a0a0;
            margin-bottom: 10px;
        }
        
        .actions {
            display: flex;
            gap: 8px;
        }
        
        .actions button {
            flex: 1;
            padding: 6px 0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
        }
        
        .play-btn {
            background:linear-gradient(to right, #28a745, #218838);
            transition: all 0.3s ease;
            color: white;
        }
        
        .play-btn:hover {
            background-color: #18662a;
            transform: scale(1.05);
            box-shadow: 0 6px 12px rgba(40, 167, 69, 0.6);
        }
        .play-btn:active {
            transform: scale(0.9);
            box-shadow: 0 3px 6px rgba(0,0,0,0.5);
        }
        
        .download-btn {
            background: linear-gradient(to right, #3385cc, #225ba3);
            transition: all 0.3s ease;
            color: white;
        }
        
        .download-btn:hover {
            background-color: #0f6d7a;
            transform: scale(1.05);
            box-shadow: 0 6px 12px rgba(51, 133, 204, 0.6);
        }
        .download-btn:active {
            transform: scale(0.9);
            box-shadow: 0 3px 6px rgba(0,0,0,0.5);
        }
        
        #videoPlayerContainer {
            margin-top: 20px;
            text-align: center;
        }
        
        #videoPlayer {
            width: 100%;
            max-width: 800px;
            height: auto;
            border-radius: 8px;
            background-color: #000;
        }
        
        .hidden {
            display: none !important;
        }

        /* 侧边栏样式 */
        #sidebar {
            position: fixed;
            top: 50%;
            right: 10px;
            transform: translateY(-50%);
            background-color: rgba(60, 60, 60, 0.8);
            border-radius: 10px;
            padding: 10px 5px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 2px;
            opacity: 0.8;
            transition: opacity 0.3s ease;
        }

        #sidebar:hover {
            opacity: 1;
        }

        .sidebar-btn {
            background: none;
            border: none;
            color: #e0e0e0;
            cursor: pointer;
            padding: 2px;
            font-size: 10px;
            font-weight: bold;
            border-radius: 5px;
            transition: background-color 0.2s ease, color 0.2s ease;
        }

        .sidebar-btn:hover, .sidebar-btn.active {
            background-color: #0066cc;
            color: white;
        }

        /* Mobile Layout Overrides */
        .mobile body {
            margin: 0;
            -webkit-text-size-adjust: 100%; /* Prevent font scaling in landscape */
        }
        .mobile .container {
            max-width: 100%;
            margin: 0;
            padding: 10px;
            border-radius: 0;
            box-shadow: none;
        }
        .mobile h1 {
            font-size: 1.5em;
            margin-top: 0;
        }
        .mobile .search-container {
            padding: 10px;
        }
        .mobile #searchForm {
            flex-wrap: wrap;
        }
        .mobile #searchInput {
            flex-basis: 100%; /* Make input take full width */
            margin-bottom: 0px;
        }
        .mobile #searchForm button {
            flex-grow: 1; /* Make buttons share remaining space */
        }
        .mobile #searchOptions label {
            display: block;
            margin-right: 0;
            margin-bottom: 8px;
        }
        .mobile .path-navigation {
            flex-wrap: nowrap;
            gap: 5px;
        }
        .mobile .path-navigation span {
            max-width: calc(100% - 200px);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .mobile .path-navigation .sorting-controls {
            margin-left: auto;
            width: auto;
        }
        
        .mobile #backButton,
        .mobile #homeButton {
            padding: 0;
            font-size: 0; /* Hide the text */
            width: 40px;
            height: 40px;
            min-width: 40px;
            position: relative;
            flex-shrink: 0;
        }

        .mobile #backButton::before,
        .mobile #homeButton::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px; /* Icon size */
            color: white;
            line-height: 1;
        }
        
        .mobile #backButton::before {
            content: '↩'; /* Back icon */
        }
        
        .mobile #homeButton::before {
            content: '⌂'; /* Home icon */
        }

        /* 移动端排序下拉菜单调整 */
        .mobile .sort-dropdown-content {
            min-width: 150px;
            right: 0;
            left: auto;
        }
        
        .mobile .sort-option label {
            font-size: 0.9em;
        }
        
        .mobile .sort-option select {
            font-size: 0.9em;
            padding: 3px;
        }
        
        /* 移动端排序图标调整 */
        .mobile .sort-menu-button {
            padding: 5px;
            font-size: 1.1em;
            min-width: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .mobile #fileGrid {
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 10px;
        }
        .mobile .grid-item {
            margin-top: 10px;
        }
        .mobile .thumbnail-container {
            height: 120px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>WebPlayer - 媒体浏览器 </h1>
        <!-- 搜索表单 -->
        <div class="search-container">
            <form id="searchForm">
                <input type="text" id="searchInput" placeholder="输入搜索关键词...">
                <button type="submit" id="searchButton">搜索</button>
                <button type="button" id="searchHelpButton">?</button>
            </form>
            <div id="searchOptions">
                <label class="search-option-label"><input type="checkbox" id="matchCase"> 区分大小写</label>
                <label class="search-option-label"><input type="checkbox" id="matchWholeWord"> 全词匹配</label>
                <label class="search-option-label"><input type="checkbox" id="useRegex"> 正则表达式</label>
                <label>最大结果数: <input type="number" id="maxResults" value="500" min="1" max="1000"></label>
            </div>
        </div>
        <div class="path-navigation">
            <button id="backButton">返回上一级</button>
            <button id="homeButton">返回主目录</button>
            <span id="currentPath">/</span>
            <div class="sorting-controls">
                <!-- 排序设置下拉菜单 -->
                <div class="sort-dropdown">
                    <button id="sortMenuButton" class="sort-menu-button">⋮</button>
                    <div id="sortDropdown" class="sort-dropdown-content hidden">
                        <div class="sort-option">
                            <label for="sortBy">排序方式:</label>
                            <select id="sortBy">
                                <option value="name">文件名</option>
                                <option value="type">文件类型</option>
                                <option value="time">修改时间</option>
                            </select>
                        </div>
                        <div class="sort-option">
                            <label for="sortOrder">排序顺序:</label>
                            <select id="sortOrder">
                                <option value="asc">升序</option>
                                <option value="desc">降序</option>
                            </select>
                        </div>
                        <div class="sort-option">
                            <label for="mixSort">
                                <input type="checkbox" id="mixSort"> 混合排序
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="rootDirsGrid" class="hidden">
            <!-- 根目录媒体目录将在此处动态加载 -->
        </div>
        <div id="fileGrid">
            <!-- 文件和文件夹将在此处动态加载 -->
        </div>
        <div id="videoPlayerContainer" class="hidden">
            <h2>正在播放: <span id="playingFileName"></span></h2>
            <video id="videoPlayer" controls autoplay></video>
            <button id="closePlayerButton">关闭播放器</button>
        </div>
    </div>

    <!-- 侧边栏导航 -->
    <div id="sidebar" class="hidden">
        <!-- 侧边栏按钮将在此处动态加载 -->
    </div>

    <script>
        function getCharGroup(char) {
            if (!char) return '...';
            if (char >= 'A' && char <= 'Z' || char >= 'a' && char <= 'z') {
                return char.toUpperCase();
            } else if (/^\d$/.test(char)) {
                return '#';
            } else if (/^[\u3040-\u309F\u30A0-\u30FF]$/.test(char)) {
                // 平假名和片假名
                return 'あ';            
            } else if (/^[\u4E00-\u9FFF\u3400-\u4DBF\uF900-\uFAFF\u3005]$/.test(char)) {
                // 汉字
                return '汉';
            } else if (/[\u3000-\u303F]/.test(char)) {
                // CJK符号和标点符号
                return '@';
            } else {
                return '...';
            }
        }

        const fileGrid = document.getElementById('fileGrid');
        const rootDirsGrid = document.getElementById('rootDirsGrid');
        const currentPathSpan = document.getElementById('currentPath');
        const backButton = document.getElementById('backButton');
        const homeButton = document.getElementById('homeButton');
        const videoPlayerContainer = document.getElementById('videoPlayerContainer');
        const videoPlayer = document.getElementById('videoPlayer');
        const playingFileNameSpan = document.getElementById('playingFileName');
        const closePlayerButton = document.getElementById('closePlayerButton');

        let currentPath = '/';
        let currentMediaDir = null;
        let currentFiles = []; // 保存当前目录的文件列表

        // 添加排序相关的变量
        const sortBy = document.getElementById('sortBy');
        const sortOrder = document.getElementById('sortOrder');

        // 添加事件监听器
        sortBy.addEventListener('change', sortAndDisplayFiles);
        sortOrder.addEventListener('change', sortAndDisplayFiles);
        document.getElementById('mixSort').addEventListener('change', sortAndDisplayFiles);
        
        // 排序下拉菜单控制
        const sortMenuButton = document.getElementById('sortMenuButton');
        const sortDropdown = document.getElementById('sortDropdown');
        
        // 点击按钮切换下拉菜单显示/隐藏
        sortMenuButton.addEventListener('click', function(e) {
            e.stopPropagation();
            sortDropdown.classList.toggle('hidden');
        });
        
        // 点击页面其他地方隐藏下拉菜单
        document.addEventListener('click', function(e) {
            if (!sortMenuButton.contains(e.target) && !sortDropdown.contains(e.target)) {
                sortDropdown.classList.add('hidden');
            }
        });
 
        // 获取根目录媒体目录列表并展示
        async function fetchRootDirs() {
            try {
                const response = await fetch('/api/root-dirs');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const dirs = await response.json();
                
                // 显示根目录网格
                rootDirsGrid.classList.remove('hidden');
                fileGrid.classList.add('hidden');
                fileGrid.innerHTML = ''; // 清空文件网格
                backButton.classList.add('hidden');
                homeButton.classList.add('hidden');
                currentPathSpan.textContent = '根目录';
                
                // 清空现有内容
                rootDirsGrid.innerHTML = '';
                
                // 展示每个媒体目录
                dirs.forEach(dir => {
                    const gridItem = document.createElement('div');
                    gridItem.className = 'grid-item';
                    
                    // 创建缩略图容器
                    const thumbnailContainer = document.createElement('div');
                    thumbnailContainer.className = 'thumbnail-container';
                    
                    // 创建文件夹图标
                    const icon = document.createElement('div');
                    icon.className = 'icon';
                    icon.innerHTML = '&#128193;'; // 文件夹图标
                    thumbnailContainer.appendChild(icon);
                    
                    // 创建文件信息容器
                    const fileInfo = document.createElement('div');
                    fileInfo.className = 'file-info';
                    
                    // 创建目录名元素
                    const dirName = document.createElement('div');
                    dirName.className = 'file-name';
                    dirName.textContent = dir.alias || dir.path; // 显示别名或路径
                    
                    // 创建路径元素
                    const dirPath = document.createElement('div');
                    dirPath.className = 'file-size';
                    dirPath.textContent = dir.path;
                    
                    // 组装文件信息
                    fileInfo.appendChild(dirName);
                    fileInfo.appendChild(dirPath);
                    
                    // 组装网格项
                    gridItem.appendChild(thumbnailContainer);
                    gridItem.appendChild(fileInfo);
                    
                    // 添加点击事件
                    gridItem.onclick = () => switchMediaDir(dir.path);
                    
                    // 添加到网格容器
                    rootDirsGrid.appendChild(gridItem);
                });
                history.replaceState({ path: 'root' }, '', '#'); // 确保回到根目录时清除历史记录
            } catch (error) {
                console.error('Error fetching root directories:', error);
                rootDirsGrid.innerHTML = `<div class="grid-item"><div class="file-info">加载目录失败: ${error.message}</div></div>`;
            }
        }

        // 切换媒体目录
        // 增加 currentPath 参数，允许在切换媒体目录后直接导航到指定路径
        async function switchMediaDir(newDir, targetPath = '/') {
            try {
                const response = await fetch('/api/set-media-dir', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ dir: newDir })
                });
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const result = await response.json();
                if (result.success) {
                    currentMediaDir = result.newMediaDir;
                    currentPath = targetPath; // 切换目录后设置为目标路径
                    updatePathDisplay();
                    fetchFiles(currentPath);
                    // 隐藏根目录网格，显示文件网格
                    rootDirsGrid.classList.add('hidden');
                    fileGrid.classList.remove('hidden');
                    console.log(`Switched to media directory: ${result.newMediaDir}`);
                    
                    // 更新浏览器历史记录
                    history.replaceState({ path: currentPath, mediaDir: newDir }, '', `#${currentPath}`);
                } else {
                    console.error('Failed to switch media directory:', result.message);
                }
            } catch (error) {
                console.error('Error switching media directory:', error);
            }
        }

        async function fetchFiles(relativePath) {
            try {
                // 对路径进行编码以防止特殊字符（如 #）引起的问题
                const encodedRelativePath = relativePath.split('/').map(segment => encodeURIComponent(segment)).join('/');
                const fetchUrl = `/list${encodedRelativePath === '/' ? '' : encodedRelativePath}`;
                const response = await fetch(fetchUrl);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const files = await response.json();
                currentFiles = files; // 保存文件列表
                sortAndDisplayFiles(); // 应用当前排序
            } catch (error) {
                console.error('Error fetching files:', error);
                fileGrid.innerHTML = `<div class="grid-item"><div class="file-info">加载文件失败: ${error.message}</div></div>`;
            }
        }

        async function sortAndDisplayFiles() {
            const sortTypeValue = sortBy.value;
            const sortOrderValue = sortOrder.value;

            // Step 1: Sort the files based on current settings
            if (sortTypeValue === 'time') {
                try {
                    const response = await fetch(`/api/sort-by-time?path=${encodeURIComponent(currentPath)}&order=${sortOrderValue}`);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    currentFiles = await response.json();
                } catch (error) {
                    console.error('Error sorting by time:', error);
                    return; // Exit if sorting fails
                }
            } else {
                currentFiles.sort((a, b) => {
                    const mixSort = document.getElementById('mixSort').checked;

                    if (!mixSort) {
                        if (a.isDirectory && !b.isDirectory) return -1;
                        if (!a.isDirectory && b.isDirectory) return 1;
                    }

                    // 当启用混合排序且按名称排序时，优先按首字母分组排序
                    if (mixSort && sortTypeValue === 'name') {
                        const groupA = getCharGroup(a.name.charAt(0));
                        const groupB = getCharGroup(b.name.charAt(0));
                        
                        // 定义分组的排序顺序
                        const groupOrder = ['#', ...'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split(''), 'あ', '汉', '@', '...'];
                        const indexA = groupOrder.indexOf(groupA);
                        const indexB = groupOrder.indexOf(groupB);
                        
                        if (indexA !== indexB) {
                            return sortOrderValue === 'asc' ? indexA - indexB : indexB - indexA;
                        }
                        
                        // 同一分组内按文件名排序
                        const compareA = a.name.toLowerCase();
                        const compareB = b.name.toLowerCase();
                        
                        if (compareA < compareB) {
                            return -1;
                        }
                        if (compareA > compareB) {
                            return 1;
                        }
                        return 0;
                    }
                    
                    let compareA, compareB;
                    switch (sortTypeValue) {
                        case 'name':
                            compareA = a.name.toLowerCase();
                            compareB = b.name.toLowerCase();
                            break;
                        case 'type':
                            compareA = a.isDirectory ? '' : a.name.split('.').pop().toLowerCase();
                            compareB = b.isDirectory ? '' : b.name.split('.').pop().toLowerCase();
                            break;
                        default: // default to name sort
                            compareA = a.name.toLowerCase();
                            compareB = b.name.toLowerCase();
                    }

                    if (compareA < compareB) {
                        return sortOrderValue === 'asc' ? -1 : 1;
                    }
                    if (compareA > compareB) {
                        return sortOrderValue === 'asc' ? 1 : -1;
                    }
                    return 0;
                });
            }

            // Step 2: Display the sorted files
            displayFiles(currentFiles);

            // Step 3: Update the sidebar based on the new sort order and settings
            const sidebar = document.getElementById('sidebar');
            const mixSortChecked = document.getElementById('mixSort').checked;
            const shouldShowSidebar = mixSortChecked && sortTypeValue === 'name';

            if (shouldShowSidebar) {
                updateSidebar();
                sidebar.classList.remove('hidden');
            } else {
                // 确保侧边栏被隐藏
                sidebar.classList.add('hidden');
                // 清空侧边栏内容
                sidebar.innerHTML = '';
            }
        }

        function displayFiles(files) {
            fileGrid.innerHTML = ''; // 清空现有网格
            videoPlayerContainer.classList.add('hidden'); // 隐藏视频播放器

            // 添加返回上一级按钮和返回主目录按钮
            if (currentPath !== '/') {
                backButton.classList.remove('hidden');
                homeButton.classList.remove('hidden');
            } else {
                backButton.classList.add('hidden');
                homeButton.classList.remove('hidden'); // 在根目录也显示返回主目录按钮
            }

            files.forEach(file => {
                // 创建网格项容器
                const gridItem = document.createElement('div');
                gridItem.className = 'grid-item';
                // 使用更安全的方式生成文件项ID，与侧边栏按钮点击处理保持一致
                gridItem.id = `file-${encodeURIComponent(file.name)}`;

                // 创建缩略图容器
                const thumbnailContainer = document.createElement('div');
                thumbnailContainer.className = 'thumbnail-container';

                // 创建文件信息容器
                const fileInfo = document.createElement('div');
                fileInfo.className = 'file-info';

                // 创建文件名元素
                const fileName = document.createElement('div');
                fileName.className = 'file-name';
                fileName.textContent = file.name;

                // 创建文件大小元素
                const fileSize = document.createElement('div');
                fileSize.className = 'file-size';
                fileSize.textContent = file.isDirectory ? '文件夹' : formatBytes(file.size);

                // 创建操作按钮容器
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'actions';

                if (file.isDirectory) {
                    // 为文件夹创建图标
                    const icon = document.createElement('div');
                    icon.className = 'icon';
                    icon.innerHTML = '&#128193;'; // 文件夹图标
                    thumbnailContainer.appendChild(icon);

                    // 文件夹点击事件
                    gridItem.onclick = () => navigateTo(file.name);
                } else {
                    // 为文件创建缩略图或图标
                    const extension = file.name.split('.').pop().toLowerCase();
                    const isImage = ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp'].includes(extension);
                    const isVideo = ['mp4', 'webm', 'ogg', 'mov', 'avi', 'mkv'].includes(extension);
                    const isAudio = ['mp3', 'flac', 'wav', 'aac', 'ogg', 'm4a'].includes(extension);
                    const encodedPath = currentPath.split('/').map(segment => encodeURIComponent(segment)).join('/');
                    const encodedFileName = encodeURIComponent(file.name);

                    if (isImage) {
                        // 图片文件显示缩略图，并用 a 标签包裹以支持 Fancybox
                        const a = document.createElement('a');
                        const imageUrl = `${encodedPath === '/' ? '' : encodedPath}/${encodedFileName}`.replace(/\\/g, '/');
                        a.href = imageUrl;
                        // a.dataset.fancybox = 'gallery'; // 移除自动扫描触发器
                        a.dataset.caption = file.name;
 
                        const img = document.createElement('img');
                        img.className = 'thumbnail lazy';
                        img.loading = 'lazy';
                        const thumbnailPath = `${encodedPath === '/' ? '' : encodedPath}/${encodedFileName}`.replace(/\\/g, '/');
                        img.dataset.src = `/thumbnail${thumbnailPath}`;
                        img.alt = file.name;
                        img.onerror = function() {
                            a.parentNode.innerHTML = '<div class="icon">&#128196;</div>'; // 替换为图标
                        };
                        a.appendChild(img);
                        thumbnailContainer.appendChild(a);
                    } else if (isVideo) {
                        // 视频文件显示缩略图
                        const img = document.createElement('img');
                        img.className = 'thumbnail lazy'; // 添加 lazy 类
                        img.loading = 'lazy'; // 添加 loading="lazy" 属性
                        // 使用服务器端生成的缩略图
                        const thumbnailPath = `${encodedPath === '/' ? '' : encodedPath}/${encodedFileName}`.replace(/\\/g, '/');
                        img.dataset.src = `/thumbnail${thumbnailPath}`; // 改为 data-src
                        img.alt = file.name;
                        img.onerror = function() {
                            // 如果缩略图加载失败，显示默认视频图标
                            thumbnailContainer.innerHTML = '';
                            const icon = document.createElement('div');
                            icon.className = 'icon';
                            icon.innerHTML = '&#128249;'; // 视频图标
                            thumbnailContainer.appendChild(icon);
                        };
                        thumbnailContainer.appendChild(img);
                    } else if (isAudio) {
                        const icon = document.createElement('div');
                        icon.className = 'icon';
                        icon.innerHTML = '&#127925;'; // 音乐图标
                        thumbnailContainer.appendChild(icon);
                    } else {
                        // 其他文件类型显示默认图标
                        const icon = document.createElement('div');
                        icon.className = 'icon';
                        icon.innerHTML = '&#128196;'; // 文件图标
                        thumbnailContainer.appendChild(icon);
                    }

                    gridItem.onclick = (e) => {
                        if (isImage) {
                            e.preventDefault(); // 阻止 a 标签的默认跳转行为
                            const imageFiles = currentFiles.filter(f => {
                                const ext = f.name.split('.').pop().toLowerCase();
                                return ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp'].includes(ext);
                            });

                            const gallery = imageFiles.map(imgFile => {
                                const imgEncodedPath = currentPath.split('/').map(segment => encodeURIComponent(segment)).join('/');
                                const imgEncodedFileName = encodeURIComponent(imgFile.name);
                                const imgUrl = `${imgEncodedPath === '/' ? '' : imgEncodedPath}/${imgEncodedFileName}`.replace(/\\/g, '/');
                                return {
                                    src: imgUrl,
                                    opts: { caption: imgFile.name }
                                };
                            });

                            const currentIndex = imageFiles.findIndex(imgFile => imgFile.name === file.name);

                            $.fancybox.open(gallery, {
                                loop: true,
                                thumbs: { autoStart: true }
                            }, currentIndex);

                        } else if (e.target.tagName.toLowerCase() !== 'img') {
                            if (isVideo) {
                                playVideo(file.name);
                            } else if (isAudio) {
                                playMusic(file.name);
                            } else {
                                downloadFile(file.name);
                            }
                        }
                    };

                    // 如果是视频文件，添加播放按钮
                    if (isVideo) {
                        const playButton = document.createElement('button');
                        playButton.textContent = '播放';
                        playButton.className = 'play-btn';
                        playButton.onclick = (e) => {
                            e.stopPropagation(); // 阻止网格项的点击事件
                            playVideo(file.name);
                        };
                        actionsDiv.appendChild(playButton);
                    } else if (isAudio) {
                        const playButton = document.createElement('button');
                        playButton.textContent = '播放';
                        playButton.className = 'play-btn';
                        playButton.onclick = (e) => {
                            e.stopPropagation();
                            playMusic(file.name);
                        };
                        actionsDiv.appendChild(playButton);
                    }

                    // 添加下载按钮
                    const downloadButton = document.createElement('button');
                    downloadButton.textContent = '下载';
                    downloadButton.className = 'download-btn';
                    downloadButton.onclick = (e) => {
                        e.stopPropagation(); // 阻止网格项的点击事件
                        downloadFile(file.name);
                    };
                    actionsDiv.appendChild(downloadButton);
                }

                // 组装文件信息
                fileInfo.appendChild(fileName);
                fileInfo.appendChild(fileSize);
                fileInfo.appendChild(actionsDiv);

                // 组装网格项
                gridItem.appendChild(thumbnailContainer);
                gridItem.appendChild(fileInfo);

                // 添加到网格容器
                fileGrid.appendChild(gridItem);
            });
        }

        // 更新侧边栏导航
        function updateSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.innerHTML = ''; // 清空现有按钮

            if (!currentFiles || currentFiles.length === 0) {
                sidebar.classList.add('hidden');
                return;
            }

            // 提取首字母并去重
            let firstChars = [...new Set(currentFiles.map(file => getCharGroup(file.name.charAt(0))))];

            // 对首字母进行排序，以确保一致性
            firstChars.sort((a, b) => {
                const order = ['#', ...'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split(''), 'あ', '汉', '@', '...'];
                const indexA = order.indexOf(a);
                const indexB = order.indexOf(b);

                if (indexA !== -1 && indexB !== -1) {
                    return indexA - indexB;
                }
                if (indexA !== -1) return -1;
                if (indexB !== -1) return 1;
                return a.localeCompare(b); // For any other characters
            });

            // 根据排序顺序调整侧边栏按钮顺序
            const sortOrderValue = document.getElementById('sortOrder').value;
            if (sortOrderValue === 'desc') {
                firstChars.reverse();
            }

            // 创建并添加按钮
            firstChars.forEach(char => {
                const btn = document.createElement('button');
                btn.className = 'sidebar-btn';
                btn.textContent = char;
                btn.onclick = () => {
                    // 移除所有按钮的 active 状态
                    document.querySelectorAll('.sidebar-btn.active').forEach(b => b.classList.remove('active'));
                    // 给当前按钮添加 active 状态
                    btn.classList.add('active');

                    // 查找当前排序下第一个匹配字符组的文件
                    const targetFile = currentFiles.find(file => getCharGroup(file.name.charAt(0)) === char);

                    if (targetFile) {
                        // 使用更安全的方式生成和查找元素ID
                        const fileId = `file-${encodeURIComponent(targetFile.name)}`;
                        const targetElement = document.getElementById(fileId);
                        if (targetElement) {
                            targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        } else {
                            // 如果通过encodeURI生成的ID找不到元素，则尝试其他可能的ID格式
                            const fallbackId = `file-${targetFile.name.replace(/[^a-zA-Z0-9\u4e00-\u9fa5]/g, '-')}`;
                            const fallbackElement = document.getElementById(fallbackId);
                            if (fallbackElement) {
                                fallbackElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            }
                        }
                    }
                };
                sidebar.appendChild(btn);
            });
            
            // 如果有按钮，则显示侧边栏
            if (firstChars.length > 0) {
                sidebar.classList.remove('hidden');
                enableSidebarScrubbing(sidebar); // 启用滑动功能
            } else {
                sidebar.classList.add('hidden');
            }
        }

        function navigateTo(folderName) {
            currentPath = path.join(currentPath, folderName);
            updatePathDisplay();
            fetchFiles(currentPath);
            // 将新路径推入浏览器历史记录
            history.pushState({ path: currentPath, mediaDir: currentMediaDir }, '', '#' + currentPath);
        }

        backButton.onclick = async () => {
            // 在导航前通知后端停止缩略图生成
            await fetch('/api/stop-thumbnail-generation', { method: 'POST' });
            // 使用浏览器历史记录的back方法，让onpopstate处理实际导航
            history.back();
        };

        homeButton.onclick = async () => {
            // 在导航前通知后端停止缩略图生成
            await fetch('/api/stop-thumbnail-generation', { method: 'POST' });
            fetchRootDirs();
            // 更新浏览器历史记录
            history.replaceState({ path: 'root' }, '', '#');
        };

        function updatePathDisplay() {
            currentPathSpan.textContent = currentPath === '/' ? '/' : currentPath.replace(/\\/g, '/'); // 统一显示为斜杠
        }

        function playVideo(fileName) {
            // 视频URL不再需要 /list 前缀
            const encodedPath = currentPath.split('/').map(segment => encodeURIComponent(segment)).join('/');
            const encodedFileName = encodeURIComponent(fileName);
            const videoUrl = `${encodedPath === '/' ? '' : encodedPath}/${encodedFileName}`.replace(/\\/g, '/'); // 统一URL斜杠，并编码路径和文件名
            
            // 在新窗口中打开视频播放页面，添加mediaDir参数
            const videoPageUrl = `video-player.html?src=${encodeURIComponent(videoUrl)}&title=${encodeURIComponent(fileName)}&mediaDir=${encodeURIComponent(currentMediaDir)}`;
            window.open(videoPageUrl, '_blank');
        }

        function playMusic(fileName) {
            const encodedPath = currentPath.split('/').map(segment => encodeURIComponent(segment)).join('/');
            const encodedFileName = encodeURIComponent(fileName);
            const musicUrl = `${encodedPath === '/' ? '' : encodedPath}/${encodedFileName}`.replace(/\\/g, '/');
            
            const musicPageUrl = `music-player.html?src=${encodeURIComponent(musicUrl)}&title=${encodeURIComponent(fileName)}&mediaDir=${encodeURIComponent(currentMediaDir)}`;
            window.open(musicPageUrl, '_blank');
        }

        closePlayerButton.onclick = () => {
            videoPlayer.pause();
            videoPlayer.src = ''; // 清空 src 停止加载
            videoPlayerContainer.classList.add('hidden');
        };

        function downloadFile(fileName) {
            // 下载URL不再需要 /list 前缀
            const encodedPath = currentPath.split('/').map(segment => encodeURIComponent(segment)).join('/');
            const encodedFileName = encodeURIComponent(fileName);
            const fileUrl = `${encodedPath === '/' ? '' : encodedPath}/${encodedFileName}`.replace(/\\/g, '/');
            const a = document.createElement('a');
            a.href = fileUrl;
            a.download = fileName; // 强制下载
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }


        // 简单的路径拼接和获取目录名函数，因为浏览器环境没有 Node.js 的 path 模块
        const path = {
            join: (...segments) => {
                // 确保所有段都是字符串，并去除多余的斜杠
                const parts = segments.map(s => String(s).replace(/[/\\]+/g, '/').replace(/^\/|\/$/g, ''));
                let result = parts.filter(s => s !== '').join('/');
                // 确保以 '/' 开头
                if (!result.startsWith('/')) {
                    result = '/' + result;
                }
                return result;
            },
            dirname: (p) => {
                const parts = p.split(/[/\\]/).filter(part => part !== '');
                if (parts.length <= 1) return '/'; // 根目录或只有一个文件/文件夹时返回根目录
                parts.pop(); // 移除最后一个部分
                return '/' + parts.join('/');
            }
        };

        function formatBytes(bytes, decimals = 2) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }


        // Intersection Observer for lazy loading
        const lazyLoadImages = () => {
            const lazyImages = document.querySelectorAll('img.lazy');
            const observer = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const img = entry.target;
                        img.src = img.dataset.src;
                        img.classList.remove('lazy');
                        observer.unobserve(img);
                    }
                });
            }, {
                rootMargin: '0px 0px 100px 0px' // Load images 100px before they enter viewport
            });

            lazyImages.forEach(img => {
                observer.observe(img);
            });
        };

        // 重新显示文件时调用懒加载
        const originalDisplayFiles = displayFiles;
        displayFiles = (files) => {
            originalDisplayFiles(files);
            lazyLoadImages();
        };

        // 处理浏览器后退按钮
        window.onpopstate = function(event) {
            if (event.state) {
                if (event.state.path === 'root' || !event.state.path) {
                    // 返回根目录媒体目录展示
                    fetchRootDirs();
                } else if (event.state.mediaDir) {
                    // 切换到指定的媒体目录，并导航到相应的路径
                    switchMediaDir(event.state.mediaDir, event.state.path);
                } else {
                    // 导航到指定路径
                    currentPath = event.state.path;
                    updatePathDisplay();
                    fetchFiles(currentPath);
                }
            } else {
                // 如果没有状态，返回根目录
                fetchRootDirs();
            }
        };

        // 搜索功能相关代码
        const searchForm = document.getElementById('searchForm');
        const searchInput = document.getElementById('searchInput');
        const searchButton = document.getElementById('searchButton');
        const searchHelpButton = document.getElementById('searchHelpButton');
        const searchOptions = document.getElementById('searchOptions');
        const matchCase = document.getElementById('matchCase');
        const matchWholeWord = document.getElementById('matchWholeWord');
        const useRegex = document.getElementById('useRegex');
        const maxResults = document.getElementById('maxResults');

        // 切换搜索选项显示/隐藏
        searchHelpButton.onclick = () => {
            const computedStyle = window.getComputedStyle(searchOptions);
            searchOptions.style.display = computedStyle.display === 'none' ? 'block' : 'none';
        };

        // 处理搜索表单提交
        searchForm.onsubmit = async (e) => {
            e.preventDefault();
            
            const query = searchInput.value.trim();
            if (!query) {
                alert('请输入搜索关键词');
                return;
            }
            
            // 收集搜索选项
            const options = {
                query: query,
                matchCase: matchCase.checked,
                matchWholeWord: matchWholeWord.checked,
                useRegex: useRegex.checked,
                maxResults: parseInt(maxResults.value) || 100
            };
            
            // 在新标签页中打开搜索结果页面
            const searchParams = new URLSearchParams(options);
            const searchUrl = `search-results.html?${searchParams.toString()}`;
            window.open(searchUrl, '_blank');
        };

        // 初始加载
        // 检查URL参数，看是否从搜索结果页面跳转过来
        const initialUrlParams = new URLSearchParams(window.location.search);
        const initialMediaDir = initialUrlParams.get('mediaDir');
        const initialPath = initialUrlParams.get('path') || '/';

        if (initialMediaDir) {
            // 如果有 mediaDir 参数，说明是从搜索结果页跳转过来，直接切换媒体目录并导航到指定路径
            switchMediaDir(initialMediaDir, initialPath);
        } else {
            // 否则，正常加载根目录媒体目录列表
            fetchRootDirs();
            // 设置初始历史状态
            history.replaceState({ path: 'root' }, '', '#');
        }
        
        // 实现侧边栏长按滑动功能
        function enableSidebarScrubbing(sidebar) {
            let isScrubbing = false;
            let lastTargetButton = null;

            const handleMove = (y) => {
                if (!isScrubbing) return;

                const button = document.elementFromPoint(sidebar.getBoundingClientRect().left + 10, y);
                if (button && button.classList.contains('sidebar-btn') && button !== lastTargetButton) {
                    
                    // 移除之前按钮的 active 状态
                    if(lastTargetButton) {
                        lastTargetButton.classList.remove('active');
                    }

                    // 触发点击事件并更新 active 状态
                    button.click();
                    button.classList.add('active');
                    lastTargetButton = button;
                }
            };

            const startScrubbing = (e) => {
                e.preventDefault();
                isScrubbing = true;
                sidebar.style.userSelect = 'none'; // 防止滑动时选中文本
                document.body.style.cursor = 'ns-resize';
                
                const y = e.clientY || e.touches[0].clientY;
                handleMove(y);
            };

            const stopScrubbing = () => {
                if (!isScrubbing) return;
                isScrubbing = false;
                sidebar.style.userSelect = '';
                document.body.style.cursor = '';
                // 移除所有 active 状态，而不仅仅是 lastTargetButton
                setTimeout(() => {
                    document.querySelectorAll('.sidebar-btn.active').forEach(b => b.classList.remove('active'));
                }, 300);
                lastTargetButton = null;
            };
            
            sidebar.addEventListener('mousedown', startScrubbing);
            sidebar.addEventListener('touchstart', startScrubbing, { passive: false });

            document.addEventListener('mousemove', (e) => {
                if(isScrubbing) handleMove(e.clientY);
            });
            document.addEventListener('touchmove', (e) => {
                if(isScrubbing) handleMove(e.touches[0].clientY);
            }, { passive: false });

            document.addEventListener('mouseup', stopScrubbing);
            document.addEventListener('touchend', stopScrubbing);
        }

    </script>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js"></script>
</body>
</html>