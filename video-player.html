<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebPlayer - Video</Video></title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/dplayer/dist/DPlayer.min.css">
    <link rel="stylesheet" href="video-player-style.css?v=1">
</head>
<body>
    <div class="player-bg"></div>
    <div class="player-container video-mode">

        <div class="player-main">
            <div class="video-header">
                <h2 id="videoTitle" class="video-title">加载中...</h2>
                <div class="video-controls-right">
                     <div class="subtitle-dropdown">
                        <button id="subtitleBtn" class="control-btn extra-btn"><i class="fas fa-closed-captioning"></i></button>
                        <div id="subtitleDropdownContent" class="subtitle-dropdown-content">
                            <!-- Subtitle options will be inserted here -->
                        </div>
                    </div>
                    <button id="externalPlayBtn" class="control-btn extra-btn" title="外部播放"><i class="fas fa-external-link-alt"></i></button>
                    <button id="downloadBtn" class="control-btn extra-btn" title="下载视频"><i class="fas fa-download"></i></button>
                    <button class="control-btn extra-btn" onclick="window.close()" title="关闭窗口"><i class="fas fa-times"></i></button>
                </div>
            </div>

            <div class="video-content-area">
                <div id="dplayer"></div>
            </div>
        </div>

    </div>

    <div id="conversionModal" class="modal" style="display: none;">
        <div class="modal-content">
            <h2 id="modalTitle">需要转码</h2>
            <p id="modalText">此视频格式 (AVI) 可能无法在浏览器中直接播放。是否要将其转换为 MP4？</p>
            <div id="progressContainer" style="display:none;">
                <div class="progress-bar-container">
                    <div id="progressBar" class="progress-bar-inner">0%</div>
                </div>
                <p id="progressInfo"></p>
            </div>
            <div id="modalActions" style="margin-bottom: 10px; display: flex; justify-content: center; gap: 15px;">
                <button id="startConversionBtn">开始转码</button>
                <button id="cancelConversionBtn">取消</button>
            </div>
            <div style="margin-bottom: 10px; display: flex; justify-content: center; gap: 15px;">
                <button id="modalDownloadBtn" class="download-btn">下载</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/dplayer/dist/DPlayer.min.js"></script>
    <script>
        const videoTitle = document.getElementById('videoTitle');
        const urlParams = new URLSearchParams(window.location.search);
        const videoSrc = urlParams.get('src');
        const title = urlParams.get('title') || '未知视频';

        videoTitle.textContent = title;

        const mediaDir = urlParams.get('mediaDir'); // 获取 mediaDir 参数
        let dp; // 将dp声明移到这里，使其在整个脚本作用域内可访问

        // 在播放视频前，先向服务器发送请求，临时设置 mediaDir
        function buildVideoUrl(src, mediaDir) {
            if (!mediaDir) return src;
            
            try {
                let url;
                try {
                    url = new URL(src);
                } catch (urlError) {
                    url = new URL(src, window.location.origin);
                }
                
                url.searchParams.set('mediaDir', mediaDir);
                return url.toString();
            } catch (e) {
                const separator = src.includes('?') ? '&' : '?';
                return `${src}${separator}mediaDir=${encodeURIComponent(mediaDir)}`;
            }
        }
        
        async function setTempMediaDirAndPlay() {
            if (mediaDir) {
                try {
                    const response = await fetch('/api/set-temp-media-dir', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ dir: mediaDir })
                    });
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const result = await response.json();
                    if (!result.success) {
                        throw new Error(result.message || 'Failed to set temporary media directory.');
                    }
                    console.log('Temporary media directory set:', mediaDir);
                } catch (error) {
                    console.error('Error setting temporary media directory:', error);
                    videoTitle.textContent = `视频加载失败: ${error.message}`;
                    return; // 如果设置失败，则不播放视频
                }
            }

            if (videoSrc) {
                const fullVideoUrl = buildVideoUrl(videoSrc, mediaDir);

                const decodedVideoSrc = decodeURIComponent(videoSrc);
                const subtitleResponse = await fetch(`/api/find-subtitles?src=${encodeURIComponent(decodedVideoSrc)}&mediaDir=${encodeURIComponent(mediaDir)}`);
                const subtitleData = await subtitleResponse.json();
                console.log('Received subtitle data from server:', subtitleData);

                const dpOptions = {
                    container: document.getElementById('dplayer'),
                    video: {
                        url: fullVideoUrl,
                        pic: urlParams.get('poster') || '',
                        thumbnails: urlParams.get('thumbnails') || '',
                        playsinline: true,
                        'webkit-playsinline': true
                    },
                    autoplay: true,
                    theme: 'var(--accent-color)',
                    lang: 'zh-cn',
                    hotkey: true,
                    screenshot: true,
                    playbackSpeed: [0.5, 0.75, 1, 1.25, 1.5, 2],
                    loop: false,
                };

                if (subtitleData.success && subtitleData.subtitles.length > 0) {
                    const subtitleUrl = subtitleData.subtitles[0].url;
                    let fullSubtitleUrl;
                    if (mediaDir) {
                        const separator = subtitleUrl.includes('?') ? '&' : '?';
                        fullSubtitleUrl = `${subtitleUrl}${separator}mediaDir=${encodeURIComponent(mediaDir)}`;
                    } else {
                        fullSubtitleUrl = subtitleUrl;
                    }
                    
                    console.log('Subtitle URL:', fullSubtitleUrl);
                    dpOptions.subtitle = {
                        url: fullSubtitleUrl,
                        type: 'webvtt',
                        fontSize: '2vw',
                        fontfamily: 'Noto Sans SC, sans-serif',
                        background:'rgba(0, 0, 0, 0.5)',
                        bottom: '5%',
                        color: '#FFFFFF'
                    };
                }
                
                function bindDPlayerEvents(player) {
                    player.on('error', function () {
                        console.error('DPlayer error occurred:', arguments);
                        videoTitle.textContent = '视频加载失败，请检查控制台获取更多信息。';
                    });

                    player.on('subtitle_error', function () {
                        console.error('DPlayer subtitle error occurred:', arguments);
                    });
                }

                function initDPlayer() {
                    dp = new DPlayer(dpOptions);
                    bindDPlayerEvents(dp);
                    loadAllSubtitles();
                    // Set background image
                    const albumCover = urlParams.get('poster');
                    if (albumCover) {
                        document.querySelector('.player-bg').style.backgroundImage = `url('${albumCover}')`;
                    }
                }

                const subtitleBtn = document.getElementById('subtitleBtn');
                const subtitleDropdownContent = document.getElementById('subtitleDropdownContent');

                subtitleBtn.onclick = () => {
                    subtitleDropdownContent.classList.toggle("show");
                };

                window.onclick = function(event) {
                    if (!event.target.closest('.subtitle-dropdown')) {
                        if (subtitleDropdownContent.classList.contains('show')) {
                            subtitleDropdownContent.classList.remove('show');
                        }
                    }
                }

                async function loadAllSubtitles() {
                    const subtitleDropdown = document.querySelector('.subtitle-dropdown');
                    try {
                        const response = await fetch(`/api/find-subtitles?src=${encodeURIComponent(decodedVideoSrc)}&mediaDir=${encodeURIComponent(mediaDir)}&all=true`);
                        const data = await response.json();
                        if (data.success && data.subtitles.length > 0) {
                            subtitleDropdown.classList.remove('no-subtitles');
                            subtitleDropdownContent.innerHTML = '';
                            const offOption = document.createElement('a');
                            offOption.textContent = '关闭字幕';
                            offOption.onclick = () => {
                                if (dp && dp.subtitle) {
                                    dp.subtitle.hide();
                                }
                                subtitleDropdownContent.classList.remove('show');
                            };
                            subtitleDropdownContent.appendChild(offOption);

                            data.subtitles.forEach(sub => {
                                const link = document.createElement('a');
                                link.textContent = sub.name;
                                link.onclick = () => {
                                    let fullSubtitleUrl = sub.url;
                                    if (mediaDir) {
                                        try {
                                            const url = new URL(sub.url, window.location.origin);
                                            url.searchParams.set('mediaDir', mediaDir);
                                            fullSubtitleUrl = url.toString();
                                        } catch (e) {
                                            const separator = sub.url.includes('?') ? '&' : '?';
                                            fullSubtitleUrl = `${sub.url}${separator}mediaDir=${encodeURIComponent(mediaDir)}`;
                                        }
                                    }
                                    console.log(`Switching to subtitle: ${fullSubtitleUrl}`);
                                    
                                    const subtitleOptions = {
                                        type: 'webvtt',
                                        fontSize: '2vw',
                                        fontfamily: 'Noto Sans SC, sans-serif',
                                        background:'rgba(0, 0, 0, 0.5)',
                                        bottom: '5%',
                                        color: '#FFFFFF'
                                    };

                                    if (dp && dp.subtitle && typeof dp.subtitle.switch === 'function') {
                                        dp.subtitle.switch(fullSubtitleUrl, subtitleOptions);
                                    } else if (dp) {
                                        const currentTime = dp.video.currentTime;
                                        const wasPaused = dp.video.paused;
                                        
                                        dp.destroy();
                                        
                                        dpOptions.subtitle = { ...subtitleOptions, url: fullSubtitleUrl };
                                        
                                        dp = new DPlayer(dpOptions);
                                        bindDPlayerEvents(dp);
                                        
                                        dp.on('loadeddata', () => {
                                            dp.seek(currentTime);
                                            if (!wasPaused) {
                                                dp.play();
                                            }
                                        });
                                    }
                                    subtitleDropdownContent.classList.remove('show');
                                };
                                subtitleDropdownContent.appendChild(link);
                            });
                        } else {
                            subtitleDropdown.classList.add('no-subtitles');
                        }
                    } catch (error) {
                        console.error('Error loading all subtitles:', error);
                        subtitleDropdown.classList.add('no-subtitles');
                    }
                }
                
                initDPlayer();

            } else {
                videoTitle.textContent = '未找到视频源';
            }
        }

        if (videoSrc && videoSrc.toLowerCase().endsWith('.avi')) {
            const modal = document.getElementById('conversionModal');
            modal.style.display = 'block';

            const startBtn = document.getElementById('startConversionBtn');
            const cancelBtn = document.getElementById('cancelConversionBtn');
            const modalTitle = document.getElementById('modalTitle');
            const modalText = document.getElementById('modalText');
            const progressContainer = document.getElementById('progressContainer');
            const progressBar = document.getElementById('progressBar');
            const progressInfo = document.getElementById('progressInfo');

            const ws = new WebSocket(`ws://${window.location.host}`);

            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                if (data.type === 'progress') {
                    progressBar.style.width = data.progress + '%';
                    progressBar.textContent = data.progress.toFixed(2) + '%';
                    progressInfo.textContent = `时间: ${data.time}, 速度: ${data.speed}`;
                } else if (data.type === 'complete') {
                    modalTitle.textContent = '转码完成!';
                    modalText.textContent = '页面即将刷新...';
                    setTimeout(() => {
                        const newUrl = new URL(window.location.href);
                        newUrl.searchParams.set('src', data.newPath);
                        window.location.href = newUrl.href;
                    }, 2000);
                } else if (data.type === 'error') {
                    modalTitle.textContent = '转码失败';
                    modalText.textContent = data.message;
                }
            };

            startBtn.onclick = async () => {
                document.getElementById('modalActions').style.display = 'none';
                document.getElementById('modalDownloadBtn').style.display = 'none';
                modalText.style.display = 'none';
                progressContainer.style.display = 'block';
                modalTitle.textContent = '正在转码...';

                await fetch('/api/convert-video', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        mediaDir: mediaDir,
                        relativePath: decodeURIComponent(videoSrc)
                    })
                });
            };

            cancelBtn.onclick = () => {
                modal.style.display = 'none';
                setTempMediaDirAndPlay();
            };
            
            const modalDownloadBtn = document.getElementById('modalDownloadBtn');

            modalDownloadBtn.onclick = () => {
                const fullVideoUrl = buildVideoUrl(videoSrc, mediaDir);
                console.log(`Attempting to download from modal: ${fullVideoUrl}`);
                window.open(fullVideoUrl, '_blank');
            };

        } else {
            setTempMediaDirAndPlay();
        }

        const externalPlayBtn = document.getElementById('externalPlayBtn');
        const downloadBtn = document.getElementById('downloadBtn');

        function playVideoExternally(videoUrl) {
            const userAgent = navigator.userAgent || navigator.vendor || window.opera;

            if (/android/i.test(userAgent)) {
                const intentUrl = 'intent:' + videoUrl + '#Intent;action=android.intent.action.VIEW;type=video/*;end';
                window.location.href = intentUrl;

            } else if (/win/i.test(userAgent)) {
                window.location.href = 'potplayer://' + videoUrl;

            } else {
                alert('此功能目前主要支持Windows和Android设备。您的浏览器将尝试直接打开视频链接。');
                window.open(videoUrl, '_blank');
            }
        }

        externalPlayBtn.addEventListener('click', () => {
            const fullVideoUrl = dp.video.currentSrc;
            if (fullVideoUrl) {
                console.log(`Attempting to play externally: ${fullVideoUrl}`);
                playVideoExternally(fullVideoUrl);
            } else {
                alert('无法获取当前视频的URL。');
                console.error('Could not get video source for external playback.');
            }
        });
        
        downloadBtn.addEventListener('click', () => {
            const fullVideoUrl = dp.video.currentSrc;
            if (fullVideoUrl) {
                console.log(`Attempting to download: ${fullVideoUrl}`);
                window.open(fullVideoUrl, '_blank');
            } else {
                alert('无法获取当前视频的URL。');
                console.error('Could not get video source for download.');
            }
        });
    </script>
</body>
</html>